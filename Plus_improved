#!/bin/bash

#=============================================================================
# SSHPlus Manager - Geliştirilmiş Versiyon v39
# Orijinal: CRAZY_VPN (@crazy_vpn)
# Geliştirme: requmen
# Tarih: 2025-12-05
# Açıklama: SSH ve VPN yönetim aracı kurulum scripti
#=============================================================================

# Renkler ve stil tanımlamaları
readonly RED='\033[1;31m'
readonly GREEN='\033[1;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[1;34m'
readonly CYAN='\033[1;36m'
readonly WHITE='\033[1;37m'
readonly RESET='\033[0m'

# Dizin tanımlamaları
readonly INSTALL_DIR="/usr/local/lib"
readonly BIN_DIR="/usr/local/bin"
readonly CONFIG_DIR="/etc/SSHPlus"
readonly LOG_FILE="/var/log/sshplus-install.log"

# GitHub repository bilgileri
readonly GITHUB_USER="requmen"
readonly GITHUB_REPO="sshplus-manager-improved"
readonly GITHUB_BRANCH="master"
readonly BASE_URL="https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}"

# Versiyon bilgisi
readonly VERSION="39"

#=============================================================================
# Yardımcı Fonksiyonlar
#=============================================================================

# Log fonksiyonu
log() {
    local level="$1"
    shift
    local message="$@"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [$level] $message" >> "$LOG_FILE"
}

# Hata mesajı göster ve çık
error_exit() {
    echo -e "${RED}[HATA]${RESET} $1" >&2
    log "ERROR" "$1"
    exit 1
}

# Bilgi mesajı göster
info() {
    echo -e "${CYAN}[BİLGİ]${RESET} $1"
    log "INFO" "$1"
}

# Başarı mesajı göster
success() {
    echo -e "${GREEN}[BAŞARILI]${RESET} $1"
    log "SUCCESS" "$1"
}

# Uyarı mesajı göster
warning() {
    echo -e "${YELLOW}[UYARI]${RESET} $1"
    log "WARNING" "$1"
}

# İlerleme çubuğu göster
progress_bar() {
    local duration=$1
    local message=$2
    local progress=0
    local bar_length=50
    
    echo -ne "${CYAN}${message}${RESET} ["
    
    while [ $progress -le $bar_length ]; do
        local filled=$((progress * 100 / bar_length))
        printf "\r${CYAN}${message}${RESET} ["
        
        for ((i=0; i<progress; i++)); do
            echo -n "${GREEN}#${RESET}"
        done
        
        for ((i=progress; i<bar_length; i++)); do
            echo -n " "
        done
        
        echo -n "] ${filled}%"
        
        progress=$((progress + 1))
        sleep $(echo "scale=3; $duration / $bar_length" | bc)
    done
    
    echo -e " ${GREEN}✓${RESET}"
}

#=============================================================================
# Kontrol Fonksiyonları
#=============================================================================

# Root kontrolü
check_root() {
    if [[ "$(whoami)" != "root" ]]; then
        error_exit "Bu script root yetkisi ile çalıştırılmalıdır. 'sudo' kullanın."
    fi
}

# İşletim sistemi kontrolü
check_os() {
    if [[ ! -f /etc/os-release ]]; then
        error_exit "Desteklenmeyen işletim sistemi"
    fi
    
    source /etc/os-release
    
    case "$ID" in
        ubuntu|debian)
            info "İşletim sistemi: $PRETTY_NAME"
            ;;
        *)
            warning "Bu işletim sistemi resmi olarak desteklenmemektedir: $PRETTY_NAME"
            read -p "Devam etmek istiyor musunuz? [e/H]: " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Ee]$ ]]; then
                exit 0
            fi
            ;;
    esac
}

# İnternet bağlantısı kontrolü
check_internet() {
    info "İnternet bağlantısı kontrol ediliyor..."
    
    if ! ping -c 1 -W 5 google.com &> /dev/null; then
        if ! ping -c 1 -W 5 8.8.8.8 &> /dev/null; then
            error_exit "İnternet bağlantısı bulunamadı"
        fi
    fi
    
    success "İnternet bağlantısı aktif"
}

# Disk alanı kontrolü
check_disk_space() {
    local required_space=1048576  # 1GB in KB
    local available_space=$(df / | awk 'NR==2 {print $4}')
    
    if [ "$available_space" -lt "$required_space" ]; then
        error_exit "Yetersiz disk alanı. En az 1GB boş alan gerekli."
    fi
    
    success "Disk alanı yeterli"
}

#=============================================================================
# Kurulum Fonksiyonları
#=============================================================================

# Banner göster
show_banner() {
    clear
    echo -e "${RED}════════════════════════════════════════════════════${RESET}"
    echo -e "${BLUE}                                                    ${RESET}"
    echo -e "${WHITE}        SSHPLUS MANAGER - GELİŞTİRİLMİŞ VERSİYON    ${RESET}"
    echo -e "${WHITE}                    Versiyon: ${VERSION}                    ${RESET}"
    echo -e "${BLUE}                                                    ${RESET}"
    echo -e "${RED}════════════════════════════════════════════════════${RESET}"
    echo ""
    echo -e "${YELLOW}Bu script aşağıdaki işlemleri gerçekleştirecektir:${RESET}"
    echo ""
    echo -e "${GREEN}•${RESET} SSH ve VPN yönetim araçlarını kuracak"
    echo -e "${GREEN}•${RESET} Sistem optimizasyonları yapacak"
    echo -e "${GREEN}•${RESET} Kullanıcı yönetim araçları ekleyecek"
    echo -e "${GREEN}•${RESET} Monitoring ve raporlama araçları kuracak"
    echo ""
    echo -e "${CYAN}DİKKAT:${RESET} Terminal temanızı ${YELLOW}koyu (dark)${RESET} yapmanız önerilir."
    echo ""
    echo -e "${RED}≠×≠×≠×≠×≠×≠×≠×≠×${RESET}[${YELLOW} • ${GREEN}BY REQUMEN${YELLOW} • ${RED}]≠×≠×≠×≠×≠×≠×≠×≠×${RESET}"
    echo ""
}

# Kullanıcı onayı al
get_confirmation() {
    read -p "$(echo -e "${CYAN}Kuruluma devam etmek istiyor musunuz? ${RED}[E/h]:${WHITE} ")" -e -i e resp
    
    if [[ $resp =~ ^[Hh]$ ]]; then
        info "Kurulum kullanıcı tarafından iptal edildi"
        rm -f "$0" > /dev/null 2>&1
        exit 0
    fi
}

# Sistem güncelleme
update_system() {
    info "Sistem güncelleniyor..."
    echo -e "${YELLOW}Bu işlem birkaç dakika sürebilir...${RESET}"
    
    if apt-get update -y >> "$LOG_FILE" 2>&1; then
        success "Sistem başarıyla güncellendi"
    else
        warning "Sistem güncellemesinde bazı hatalar oluştu"
    fi
}

# Gerekli paketleri kur
install_packages() {
    info "Gerekli paketler kuruluyor..."
    
    local packages=(
        "bc"
        "screen"
        "nano"
        "vim"
        "unzip"
        "lsof"
        "net-tools"
        "dos2unix"
        "nload"
        "jq"
        "curl"
        "wget"
        "figlet"
        "python3"
        "python3-pip"
        "git"
        "htop"
        "iftop"
    )
    
    local failed_packages=()
    
    for package in "${packages[@]}"; do
        echo -ne "${CYAN}Kuruluyor: ${WHITE}${package}${RESET}..."
        
        if apt-get install -y "$package" >> "$LOG_FILE" 2>&1; then
            echo -e " ${GREEN}✓${RESET}"
        else
            echo -e " ${RED}✗${RESET}"
            failed_packages+=("$package")
        fi
    done
    
    # Python paketleri
    if pip3 install speedtest-cli >> "$LOG_FILE" 2>&1; then
        success "Python paketleri kuruldu"
    else
        warning "Bazı Python paketleri kurulamadı"
    fi
    
    if [ ${#failed_packages[@]} -gt 0 ]; then
        warning "Şu paketler kurulamadı: ${failed_packages[*]}"
    else
        success "Tüm paketler başarıyla kuruldu"
    fi
}

# Firewall yapılandır
configure_firewall() {
    if [[ -f "/usr/sbin/ufw" ]]; then
        info "Firewall yapılandırılıyor..."
        
        ufw allow 22/tcp >> "$LOG_FILE" 2>&1
        ufw allow 80/tcp >> "$LOG_FILE" 2>&1
        ufw allow 443/tcp >> "$LOG_FILE" 2>&1
        ufw allow 3128/tcp >> "$LOG_FILE" 2>&1
        ufw allow 8080/tcp >> "$LOG_FILE" 2>&1
        ufw allow 8799/tcp >> "$LOG_FILE" 2>&1
        
        success "Firewall kuralları eklendi"
    fi
}

# SSH yapılandırması yedekle
backup_ssh_config() {
    local backup_file="/etc/ssh/sshd_back_$(date +%Y%m%d_%H%M%S).conf"
    
    if cp /etc/ssh/sshd_config "$backup_file" >> "$LOG_FILE" 2>&1; then
        success "SSH yapılandırması yedeklendi: $backup_file"
    else
        warning "SSH yapılandırması yedeklenemedi"
    fi
}

# Dizinleri oluştur
create_directories() {
    info "Gerekli dizinler oluşturuluyor..."
    
    local directories=(
        "$CONFIG_DIR"
        "$CONFIG_DIR/senha"
        "$CONFIG_DIR/userteste"
        "$CONFIG_DIR/.tmp"
        "/etc/bot"
        "/etc/bot/info-users"
        "/etc/bot/arquivos"
        "/etc/bot/revenda"
        "/etc/bot/suspensos"
    )
    
    for dir in "${directories[@]}"; do
        if [[ ! -d "$dir" ]]; then
            mkdir -p "$dir" >> "$LOG_FILE" 2>&1
        fi
    done
    
    # Gerekli dosyaları oluştur
    touch "$CONFIG_DIR/Exp" >> "$LOG_FILE" 2>&1
    touch "/etc/bot/lista_ativos" >> "$LOG_FILE" 2>&1
    touch "/etc/bot/lista_suspensos" >> "$LOG_FILE" 2>&1
    
    success "Dizinler oluşturuldu"
}

# Modülleri indir ve kur
install_modules() {
    info "Modüller indiriliyor ve kuruluyor..."
    
    local modules=(
        "menu" "criarusuario" "remover" "alterarsenha" "sshmonitor"
        "conexao" "detalhes" "otimizar" "speedtest" "banner"
        "botssh" "slow_dns" "addhost" "delhost" "badvpn"
        "blockt" "limiter" "userbackup" "alterarlimite" "ajuda"
        "criarteste" "droplimiter" "expcleaner" "infousers"
        "instsqd" "mudardata" "reiniciarservicos" "reiniciarsistema"
        "attscript" "delscript" "verifatt" "uexpired" "senharoot"
        "verifbot"
    )
    
    for module in "${modules[@]}"; do
        echo -ne "${CYAN}İndiriliyor: ${WHITE}${module}${RESET}..."
        
        if wget -qO "/bin/${module}" "${BASE_URL}/Modulos/${module}" >> "$LOG_FILE" 2>&1; then
            chmod +x "/bin/${module}" >> "$LOG_FILE" 2>&1
            echo -e " ${GREEN}✓${RESET}"
        else
            echo -e " ${RED}✗${RESET}"
        fi
    done
    
    success "Modüller kuruldu"
}

# Kurulum tamamlandı mesajı
show_completion() {
    clear
    echo ""
    echo -e "${GREEN}════════════════════════════════════════════════════${RESET}"
    echo -e "${WHITE}                                                    ${RESET}"
    echo -e "${WHITE}           KURULUM BAŞARIYLA TAMAMLANDI!           ${RESET}"
    echo -e "${WHITE}                                                    ${RESET}"
    echo -e "${GREEN}════════════════════════════════════════════════════${RESET}"
    echo ""
    echo -e "${CYAN}Ana menüyü açmak için şu komutu kullanın:${RESET}"
    echo -e "${GREEN}  menu${RESET}"
    echo ""
    echo -e "${CYAN}Daha fazla bilgi için:${RESET}"
    echo -e "${WHITE}  GitHub: ${BLUE}https://github.com/${GITHUB_USER}/${GITHUB_REPO}${RESET}"
    echo ""
    echo -e "${YELLOW}Kurulum log dosyası: ${WHITE}${LOG_FILE}${RESET}"
    echo ""
}

#=============================================================================
# Ana Program
#=============================================================================

main() {
    # Log dosyasını başlat
    mkdir -p "$(dirname "$LOG_FILE")"
    echo "=== SSHPlus Manager Kurulum Başladı: $(date) ===" > "$LOG_FILE"
    
    # Ön kontroller
    check_root
    check_os
    check_internet
    check_disk_space
    
    # Banner ve onay
    show_banner
    get_confirmation
    
    # Kurulum adımları
    update_system
    install_packages
    backup_ssh_config
    create_directories
    configure_firewall
    install_modules
    
    # Tamamlandı mesajı
    show_completion
    
    # Temizlik
    log "INFO" "Kurulum tamamlandı"
    rm -f "$0" >> "$LOG_FILE" 2>&1
}

# Programı başlat
main "$@"
